<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ Merry Christmas My Love ğŸ„</title>
    <style>
        /* --- æ ·å¼éƒ¨åˆ† (ä¿æŒä½ å–œæ¬¢çš„ç¬¬ä¸€ç‰ˆé£æ ¼) --- */
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            font-family: 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        canvas#fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200; /* <--- å…³é”®ä¿®æ”¹ï¼šæåˆ°æœ€å‰é¢ï¼ */
            pointer-events: none; /* å…³é”®ï¼šè¿™å¥å¿…é¡»ä¿ç•™ï¼Œå¦åˆ™ç‚¹ä¸åŠ¨æŒ‰é’® */
        }

        .snowflake {
            position: absolute; top: -10px; color: #fff; font-size: 1em;
            animation: fall linear infinite; z-index: 1;
        }
        @keyframes fall { to { transform: translateY(105vh); } }

        #game-container { text-align: center; z-index: 10; position: relative; }

        h1 {
            font-size: 2.5rem;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #00ff00;
            margin-bottom: 30px;
        }

        .gift-box-container {
            display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;
        }

        .gift-box {
            width: 80px; height: 80px; background-color: #d63031;
            border-radius: 10px; position: relative; cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; z-index: 20;
        }

        .gift-box::before { content: ''; position: absolute; width: 100%; height: 15px; background-color: #fdcb6e; top: 50%; transform: translateY(-50%); }
        .gift-box::after { content: ''; position: absolute; height: 100%; width: 15px; background-color: #fdcb6e; left: 50%; transform: translateX(-50%); }

        .gift-box:hover { transform: scale(1.1) rotate(5deg); }
        .gift-box.opened { background-color: #636e72; cursor: default; opacity: 0.5; pointer-events: none; }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            justify-content: center; align-items: center; flex-direction: column;
            animation: fadeIn 0.5s;
        }

        /* å›¾ç‰‡æ ·å¼ */
        .modal img {
            max-width: 90%; max-height: 60vh;
            border: 5px solid white; border-radius: 10px;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
            display: none; /* é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
        }
        
        /* è§†é¢‘æ ·å¼ (æ–°å¢) */
        .modal video {
            max-width: 90%; max-height: 60vh;
            border: 5px solid white; border-radius: 10px;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
            display: none; /* é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
        }

        .modal p {
            font-size: 1.4rem; margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px; border-radius: 20px;
            min-height: 1.5em; /* é˜²æ­¢æ–‡å­—åˆ‡æ¢æ—¶è·³åŠ¨ */
            transition: opacity 0.3s;
        }

        .skip-btn {
            margin-top: 20px; padding: 8px 20px;
            background-color: transparent; border: 1px solid #7f8c8d;
            color: #bdc3c7; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
        }

        /* æœ€ç»ˆä¿¡ä»¶ */
        #final-letter-modal { display: none; }
        #final-letter {
            background: white; color: #333; padding: 40px;
            border-radius: 10px; max-width: 80%; width: 500px;
            text-align: left; position: relative; line-height: 1.8;
            font-size: 1.1rem; box-shadow: 0 0 30px #fdcb6e;
        }
        #final-letter h2 { color: #d63031; margin-top: 0; }
        .close-btn { 
            margin-top: 20px; padding: 10px 30px; background-color: #d63031;
            color: white; border: none; border-radius: 20px; cursor: pointer;
        }
        #music-control {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
            z-index: 200;
            font-size: 20px;
            border: 1px solid rgba(255,255,255,0.5);
            animation: rotateMusic 4s linear infinite;
            /* é»˜è®¤æš‚åœåŠ¨ç”»ï¼Œæ’­æ”¾æ—¶æ‰è½¬ */
            animation-play-state: paused; 
        }

        @keyframes rotateMusic {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯éŸ³ä¹ (è®°å¾—æŠŠ src æ”¹æˆä½ çš„éŸ³ä¹æ–‡ä»¶å) -->
    <audio id="bgm" src="music.flac" loop preload="auto"></audio>

    <!-- éŸ³ä¹å¼€å…³æŒ‰é’® (å³ä¸Šè§’) -->
    <div id="music-control" onclick="toggleMusic()">ğŸµ</div>
    <canvas id="fireworks"></canvas>
    <div id="snow-container"></div>

    <div id="game-container">
        <h1>ğŸ„ äº²çˆ±çš„ï¼Œå¹³å®‰å¤œå¿«ä¹ ğŸ„</h1>
        <p>æ¯ä¸€ä»½ç¤¼ç‰©é‡Œï¼Œéƒ½è—ç€ä¸€æ®µæˆ‘ä»¬çš„æ•…äº‹...</p>
        <div class="gift-box-container">
            <div class="gift-box" onclick="playMemory(1)">ğŸ</div>
            <div class="gift-box" onclick="playMemory(2)">ğŸ</div>
            <div class="gift-box" onclick="playMemory(3)">ğŸ</div>
            <div class="gift-box" onclick="playMemory(4)">ğŸ</div>
            <div class="gift-box" onclick="playMemory(5)">ğŸ</div>
            <div class="gift-box" onclick="playMemory(6)">ğŸ</div>
        </div>
    </div>

    <!-- æ’­æ”¾å¼¹çª— -->
    <div id="media-modal" class="modal">
        <img id="modal-img" src="" alt="">
        <video id="modal-video" src="" controls></video>
        <p id="modal-text"></p>
        <!-- å³ä¸Šè§’å€’è®¡æ—¶æˆ–è·³è¿‡æŒ‰é’® -->
        <button class="skip-btn" onclick="forceStop()">è·³è¿‡å½“å‰æ•…äº‹</button>
    </div>

    <!-- æœ€ç»ˆä¿¡ä»¶ -->
    <div id="final-letter-modal" class="modal">
        <div id="final-letter">
            <h2>To æˆ‘çš„å¥³å­©ï¼š</h2>
            <p>
                æ­å–œä½ é›†é½äº†æ‰€æœ‰çš„å›å¿†ç¢ç‰‡ï¼<br><br>
                ä»Šå¤©æˆ‘ä»¬åœ¨ä¸€èµ·åŠå¹´å•¦ï¼ä¹Ÿæ˜¯å¹³å®‰å¤œï¼<br>
                åˆšæ‰çœ‹åˆ°çš„é‚£äº›ç”»é¢ï¼Œæ˜¯æˆ‘è¿™è¾ˆå­æœ€æœ€æœ€æœ€æœ€çè´µçš„å®è—ï¼<br>
                ä¸ç®¡æ˜¯ç…§ç‰‡é‡Œçš„ç¬é—´ï¼Œè¿˜æ˜¯è§†é¢‘é‡Œçš„ç¬‘å£°ï¼Œæˆ‘éƒ½æƒ³å’Œä½ ä¸€èµ·å»¶ç»­ä¸‹å»ï¼Œæ°¸è¿œæ°¸è¿œ~<br><br>
                <strong>æˆ‘çˆ±ä½ ï¼å®å®ï¼åœ£è¯å¿«ä¹ï¼ï¼ï¼ï¼ğŸ</strong>
            </p>
            <div style="text-align: center; margin-top:20px;">
                <button class="close-btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. æ ¸å¿ƒé…ç½®åŒºï¼šè¯·åœ¨è¿™é‡Œä¿®æ”¹ä½ çš„å†…å®¹ ---
        // æ³¨æ„æ ¼å¼ï¼šæ¯ä¸ªç¤¼ç‰©IDå¯¹åº”ä¸€ä¸ªæ•°ç»„ []ï¼Œæ•°ç»„é‡ŒåŒ…å«å¤šä¸ªå¯¹è±¡ {}
        // type: 'image' (å›¾ç‰‡) æˆ– 'video' (è§†é¢‘)
        // src: æ–‡ä»¶é“¾æ¥
        // text: å¯¹åº”æ˜¾ç¤ºçš„æ–‡å­—
        // duration: å›¾ç‰‡æ˜¾ç¤ºçš„æ¯«ç§’æ•° (è§†é¢‘ä¸éœ€è¦å¡«ï¼Œä¼šè‡ªåŠ¨ç­‰è§†é¢‘æ’­å®Œ)
        
        const memories = {
            1: [
                { type: 'image', src: './img/æ‰“éº»å°†.jpg', text: 'é‚£æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡è§é¢çš„éº»å°†é¦†...', duration: 3000 },
                { type: 'image', src: './img/ç”µå½±.png', text: 'çº¦ä¼šçœ‹ç”µå½±ï¼Œä½ ä¸€ç›´é ç€æˆ‘ï¼Œç¬¬ä¸€æ¬¡è¢«äººé ç€æ„Ÿè§‰å¥½å¹¸ç¦å•Š', duration: 4000 },
                // å¦‚æœä½ æœ‰è§†é¢‘ï¼Œè§£é™¤ä¸‹é¢æ³¨é‡Šå¹¶å¡«å…¥é“¾æ¥
                // { type: 'video', src: 'ä½ çš„è§†é¢‘é“¾æ¥.mp4', text: 'è¿™é‡Œæ”¾äº†ä¸€æ®µæˆ‘ä»¬çš„å°è§†é¢‘~' },
                { type: 'image', src: './img/ç¬¬ä¸€æ¬¡åš.JPG', text: 'ä»æ­¤ï¼Œæˆ‘çš„ä¸–ç•Œå¤šäº†ä¸€ä¸ªä½ ï¼Œé‚£å¤©æˆ‘ä»¬äº¤ç»‡åœ¨äº†ä¸€èµ·ã€‚ã€‚ã€‚', duration: 3000 }
            ],
            2: [
                { type: 'image', src: './img/ç¬¬ä¸€æ¬¡ä½.JPG', text: 'ç¬¬ä¸€æ¬¡å»é”¡ä¸Šmonoï¼æ„Ÿè§‰ä½ å¥½å¼€å¿ƒï¼é‚£å¤©è¿‡å¾—å¾ˆå¹¸ç¦ã€‚è¿˜è®°å¾—å½“æ™šæˆ‘å¯¹èŠ±ç²‰è¿‡æ•çš„æ•…äº‹å—å“ˆå“ˆå“ˆ', duration: 3000 },
            ],
            3: [
                { type: 'video', src: './img/æµ·è¾¹.mp4', text: 'è¿˜è®°å¾—æµ·è¾¹çš„æ•…äº‹å—ï¼Ÿå¬ç€æµ·æµªå£°æ„Ÿè§‰ç‰¹å®‰å¿ƒå‘¢ã€‚' },
            ],
            4: [
                { type: 'image', src: './img/åŒå±…1.JPG', text: 'å¼€å¯äº†æ²¡ç¾æ²¡è‡Šçš„åŒå±…ç”Ÿæ´»ã€‚ã€‚ã€‚', duration: 3000 },
                { type: 'image', src: './img/åŒå±…2.JPG', text: 'æŸä¸€å¤©æ¸…æ™¨ã€‚ã€‚é˜³å…‰æ’’è¿›æˆ¿é—´ã€‚ã€‚è¿˜æœ‰ç†Ÿç¡çš„ä½ ã€‚ã€‚ã€‚', duration: 3000 },
            ],
            5: [
                { type: 'image', src: './img/1.jpg', text: 'æ¥å—äº¬å•¦', duration: 2500 },
                { type: 'image', src: './img/2.jpg', text: 'è¿™é‡Œæœ‰å¾ˆå¤šæˆ‘ä»¬çš„å›å¿†ï¼', duration: 2500 },
                { type: 'image', src: './img/3.jpg', text: 'è°¢è°¢å®å®ï¼æ¯å‘¨éƒ½ç•™ä¸‹äº†è‡ªæ‹ã€‚ã€‚ã€‚', duration: 2500 },
                { type: 'image', src: './img/4.jpg', text: 'ã€‚ã€‚ã€‚', duration: 2500 },
                { type: 'image', src: './img/5.jpg', text: 'ã€‚ã€‚ã€‚', duration: 2500 },
                { type: 'image', src: './img/6.jpg', text: 'ç®€ç›´å°±æ˜¯å¤§å°å§ï¼', duration: 2500 },
                { type: 'image', src: './img/7.jpg', text: 'å¥½å¯çˆ±å¥½å¯çˆ±å¥½å¯çˆ±ï¼ï¼ï¼ï¼ï¼', duration: 2500 },
                { type: 'image', src: './img/8.jpg', text: 'ç¬¬ä¸€æ¬¡åƒäº‘å—èœå‘€ï¼Œè·¯ä¸Šçš„ä¿®ç‹—ä¹Ÿå¾ˆå¥½ç©', duration: 2500 },
                { type: 'image', src: './img/9.jpg', text: 'å‘œå‘œå‘œè¿™å¤©å°±æ¥äº†ä¸€å¤©ï¼Œä½†æ˜¯è¿‡å¾—å¾ˆå……å®ï¼', duration: 2500 },
                { type: 'image', src: './img/10.jpg', text: 'æˆ‘ä»¬å»äº†æ¤ç‰©å›­ï¼ï¼ï¼æˆ‘çœ‹èµ·æ¥å’‹è¿™ä¹ˆè™šï¼ï¼ï¼', duration: 2500 },
                { type: 'image', src: './img/11.jpg', text: 'å®å®çš„ç”Ÿæ—¥ï¼ï¼ï¼çªçˆ±æ³¥ï¼ï¼ï¼ï¼', duration: 2500 },
                { type: 'image', src: './img/12.jpg', text: 'æœ€åä¸€å¤©ï¼Œé©¬ä¸Šå°±è¦ä¸Šé«˜é“äº†ï¼Œå¥½éš¾è¿‡å‘€ğŸ˜­', duration: 2500 },
                { type: 'image', src: './img/13.jpg', text: 'æ¥æ— é”¡æ”¯æŒå®å®', duration: 2500 },
                { type: 'image', src: './img/14.jpg', text: 'åˆæ¥äº†ä¸€æ¬¡å“ˆå“ˆå“ˆï¼Œç¬¬ä¸€æ¬¡å°è¯•é‚£ä¸ªğŸ˜', duration: 2500 },
                { type: 'image', src: './img/15.jpg', text: 'å¿«åˆ°ç»“å°¾å•¦ï¼Œçˆ±ä½ çˆ±ä½ çˆ±ä½ ï¼', duration: 2500 },
            ],
            6: [
                { type: 'video', src: './img/ç”Ÿæ—¥.mp4', text: 'ç”Ÿæ—¥å¿«ä¹ï¼ï¼ï¼ï¼ï¼æˆ‘ä»¬è¦æ°¸è¿œåœ¨ä¸€èµ·ï¼ï¼ï¼' },
            ]
        };

        // --- 2. æ’­æ”¾é€»è¾‘ ---
        let currentGiftId = 0;
        let slideIndex = 0;
        let slideTimer = null;
        let openedCount = 0;
        const totalGifts = 5;

        function playMemory(id) {
            const box = document.querySelectorAll('.gift-box')[id-1];
            if (box.classList.contains('opened')) return;

            if (bgm.paused && !isMusicPlaying) {
                toggleMusic();
            }

            currentGiftId = id;
            slideIndex = 0;
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('media-modal').style.display = 'flex';
            
            // æ ‡è®°ç›’å­
            box.classList.add('opened');
            box.innerHTML = 'âœ¨'; 

            // å¼€å§‹æ’­æ”¾ç¬¬ä¸€ä¸ªç‰‡æ®µ
            showSlide();
        }

        function showSlide() {
            const list = memories[currentGiftId];
            
            // å¦‚æœæ’­å®Œäº†
            if (slideIndex >= list.length) {
                closeModal();
                return;
            }

            const item = list[slideIndex];
            const imgEl = document.getElementById('modal-img');
            const videoEl = document.getElementById('modal-video');
            const textEl = document.getElementById('modal-text');

            // æ›´æ–°æ–‡å­—
            textEl.style.opacity = 0;
            setTimeout(() => {
                textEl.innerText = item.text;
                textEl.style.opacity = 1;
            }, 300);

            // æ ¹æ®ç±»å‹æ˜¾ç¤ºå†…å®¹
            if (item.type === 'image') {
                videoEl.style.display = 'none';
                videoEl.pause();

                // ã€å…³é”®é€»è¾‘ã€‘å¦‚æœæ˜¯å›¾ç‰‡ï¼Œä¸”ä¹‹å‰å¼€å¯äº†BGMï¼Œåˆ™æ¢å¤æ’­æ”¾BGM
                if (isMusicPlaying && bgm.paused) {
                    bgm.play();
                }
                
                imgEl.src = item.src;
                imgEl.style.display = 'block';

                // è®¾ç½®å®šæ—¶å™¨åˆ‡æ¢ä¸‹ä¸€å¼ 
                slideTimer = setTimeout(() => {
                    slideIndex++;
                    showSlide();
                }, item.duration || 3000);

            } else if (item.type === 'video') {
                imgEl.style.display = 'none';

                // ã€å…³é”®é€»è¾‘ã€‘å¦‚æœæ˜¯è§†é¢‘ï¼Œæš‚åœèƒŒæ™¯éŸ³ä¹
                bgm.pause();
                
                videoEl.src = item.src;
                videoEl.style.display = 'block';
                videoEl.play();

                // ç›‘å¬è§†é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
                videoEl.onended = () => {
                    slideIndex++;
                    showSlide();
                };
            }
        }

        function forceStop() {
            if (slideTimer) clearTimeout(slideTimer);
            const videoEl = document.getElementById('modal-video');
            videoEl.pause();
            closeModal();
        }

        function closeModal() {
            
            document.getElementById('media-modal').style.display = 'none';
            if (slideTimer) clearTimeout(slideTimer);
            if (isMusicPlaying) {
                bgm.play();
            }
            // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨æ‰“å¼€
            if (openedCount === totalGifts) {
                setTimeout(showFinalLetter, 500);
            }
            openedCount++;
        }

        function showFinalLetter() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('final-letter-modal').style.display = 'flex';
            startFireworks();
        }

        // --- 3. è§†è§‰ç‰¹æ•ˆ (é›ªèŠ±+çƒŸèŠ±) ---
        function createSnow() {
            const container = document.body;
            for (let i = 0; i < 50; i++) {
                const snow = document.createElement('div');
                snow.className = 'snowflake';
                snow.innerHTML = 'â„';
                snow.style.left = Math.random() * 100 + 'vw';
                snow.style.animationDuration = Math.random() * 3 + 2 + 's';
                snow.style.opacity = Math.random();
                snow.style.fontSize = Math.random() * 20 + 10 + 'px';
                container.appendChild(snow);
            }
        }

        let canvas, ctx, particles = [];
        function startFireworks() {
            canvas = document.getElementById('fireworks');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            loop();
            setInterval(() => {
                createFirework(Math.random() * canvas.width, Math.random() * canvas.height * 0.6 + canvas.height * 0.1);
            }, 800);
            createFirework(canvas.width / 2, canvas.height / 3);
        }
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createFirework(x, y) {
            // æ•°é‡ä» 80 æ”¹ä¸º 150ï¼Œæ›´å¯†é›†
            const particleCount = 150; 
            const colors = ['#ff7675', '#fab1a0', '#ffeaa7', '#55efc4', '#74b9ff', '#ff0000', '#ffff00'];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle(x, y, colors[Math.floor(Math.random() * colors.length)]));
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                // çˆ†ç‚¸èŒƒå›´å˜å¤§ (åŸæ¥æ˜¯ 6+2 -> æ”¹ä¸º 10+2)
                const velocity = Math.random() * 10 + 2; 
                const angle = Math.random() * Math.PI * 2;
                this.dx = Math.cos(angle) * velocity;
                this.dy = Math.sin(angle) * velocity;
                this.alpha = 1;
                // æ¶ˆå¤±é€Ÿåº¦å˜æ…¢ (åŸæ¥æ˜¯ 0.02 -> æ”¹ä¸º 0.01)ï¼ŒçƒŸèŠ±åœç•™æ›´ä¹…
                this.decay = 0.01; 
                this.gravity = 0.05;
            }
            draw() {
                ctx.save();
                
                // ã€ä¿®å¤ä»£ç ã€‘åŠ ä¸€ä¸ªåˆ¤æ–­ï¼šå¦‚æœé€æ˜åº¦å°äº0ï¼Œå°±å¼ºåˆ¶è®¾ä¸º0ï¼Œé˜²æ­¢å›å…‰è¿”ç…§
                let safeAlpha = this.alpha;
                if (safeAlpha < 0) safeAlpha = 0;
                ctx.globalAlpha = safeAlpha;
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.restore();
            }
            update() {
                this.x += this.dx;
                this.y += this.dy;
                this.dy += this.gravity;
                this.alpha -= this.decay;
                // é˜»åŠ›å‡å°ï¼Œç‚¸å¾—æ›´å¼€
                this.dx *= 0.96; 
                this.dy *= 0.96;
            }
        }
        function loop() {
            requestAnimationFrame(loop); ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => { if (p.alpha > 0) { p.update(); p.draw(); } else particles.splice(i, 1); });
        }

        // --- æ–°å¢ï¼šéŸ³ä¹æ§åˆ¶é€»è¾‘ ---
        const bgm = document.getElementById('bgm');
        const musicBtn = document.getElementById('music-control');
        let isMusicPlaying = false;

        function toggleMusic() {
            if (bgm.paused) {
                bgm.play();
                isMusicPlaying = true;
                musicBtn.style.animationPlayState = 'running'; // å¼€å§‹æ—‹è½¬
                musicBtn.style.opacity = 1;
            } else {
                bgm.pause();
                isMusicPlaying = false;
                musicBtn.style.animationPlayState = 'paused'; // åœæ­¢æ—‹è½¬
                musicBtn.style.opacity = 0.5;
            }
        }

        window.onload = createSnow;
    </script>
</body>
</html>
